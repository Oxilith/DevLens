@using Application
@using Application.Services
@using Domain.Entities
@using Domain.Models
@inject IJSRuntime JS

@rendermode InteractiveServer
@if (_isLoading)
{
    <div class="loading-spinner">
        <div class="loader"></div>
    </div>
}else if (!Data!.Any())
{
    <p>Nothing to show...</p>
}
else
{
    <div class="row">
        @foreach (var item in Data!)
        {
            <div class="col-md-6 mb-4">
                <div class="chart-container" style="position: relative; height:200px!important; width: 600px!important;">
                    <div class="card shadow-lg">
                        <div class="card-header">
                            <h6>@item.FileName</h6>
                        </div>
                        <div class="card-body">
                            <canvas id="chart_@item.FileName.Replace(".", "_")"></canvas>
                        </div>
                    </div>
                </div>
                <br/>
            </div>
        }
    </div>
}

@code {
    private readonly Random _random = new(DateTimeOffset.UtcNow.Millisecond);
    private bool _isLoading = true;
    public IReadOnlyCollection<ChangeDataModel>? Data { get; set; }

    [CascadingParameter(Name = "Changes")] public IReadOnlyCollection<ProjectChange>? Changes { get; set; }
    [Parameter] public required FileType FileType { get; set; }
    [Parameter] public int Limit { get; set; } = 0;

    [Inject] public required IConfiguration Configuration { get; set; }
    [Inject] public required ILogger<ChangeDataService> Logger { get; set; }
    
    protected override Task OnInitializedAsync()
    {
        if (Changes != null)
        {
            var dataService = new ChangeDataService(Logger, Configuration, Changes, FileType);
            Data = dataService.GetData(Limit);
        }
        return Task.CompletedTask;
    }
    
    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await RenderProjectChart();
        }
    }

    private async Task RenderProjectChart()
    {
        if (Data != null)
            foreach (var item in Data)
            {
                var filename = item.FileName;
                var months = item.MonthlyChangesOrdered.Select(x => x.Month.ToString()).ToArray();
                var counts = item.MonthlyChangesOrdered.Select(x => x.ChangeCount).ToArray();

                var chartData = new
                {
                    labels = months,
                    datasets = new[]
                    {
                        new
                        {
                            label = $"Changes in {filename}",
                            data = counts,
                            borderColor = $"rgba({_random.Next(1, 255)}, {_random.Next(1, 255)}, {_random.Next(1, 255)}, {_random.Next(1, 255)})",
                            borderWidth = 1
                        }
                    }
                };

                await JS.InvokeVoidAsync("renderChart", $"chart_{filename.Replace(".", "_")}", chartData);
            }
    }
}